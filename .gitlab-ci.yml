image: maven:3.6.3-jdk-11-slim
stages:
  - setup
  - build
  - test
  - release
  - deploy

variables:
  MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  SPRING_PROFILES_ACTIVE: ${CI_COMMIT_REF_SLUG}

setup_job:
  stage: setup
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
    DOCKER_BUILD_ID: ${CI_COMMIT_REF_NAME}_${CI_COMMIT_SHORT_SHA}
    IMAGE_TAG: ${CI_COMMIT_REF_SLUG}
  script:
    - echo ${IMAGE_NAME}
    - echo ${DOCKER_BUILD_ID}
    - echo ${IMAGE_TAG}
    - echo ${CI_BUILD_REF_NAME}
  when: manual

cache:
  paths:
    - $CI_PROJECT_DIR/.m2/repository

maven_build_job:
  stage: build
  only:
    changes:
      - greeting/**/*
  script:
    - mvn $MAVEN_CLI_OPTS clean package -DskipTests
  artifacts:
    when: on_success
    expire_in: 10 min
    paths:
      - greeting/target/*.jar

maven_test_job:
  stage: test
  only:
    changes:
      - greeting/**/*
  script:
    - mvn $MAVEN_CLI_OPTS verify -Dspring.profiles.active=${SPRING_PROFILES_ACTIVE}

maven_release_job:
  image: maven:3.6.3-jdk-11-slim
  stage: release
  before_script:
    ##
    ## Install ssh-agent if not already installed, it is required by Docker.
    ## (change apt-get to yum if you use an RPM-based image)
    ##
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    ##
    ## Run ssh-agent (inside the build environment)
    ##
    - eval $(ssh-agent -s)
    ##
    ## Add the SSH key stored in SSH_PRIVATE_KEY variable to the agent store
    ##
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    ##
    ## Create the SSH directory and give it the right permissions
    ##
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    ##
    ## Use ssh-keyscan to scan the keys of your private server
    ##
    - ssh-keyscan -t rsa gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    ##
    ## Optionally, set the git username and email
    ##
  script:
    - git config --global user.name ${RELEASE_USER_NAME}
    - git config --global user.email ${RELEASE_USER_EMAIL}
    - ssh -tt git@gitlab.com
#   - git clone git@gitlab.com:Nakebenihime/deployment-workshop.git {SSH_GIT_URL}
#   - git remote set-url origin ssh://git@gitlab.com:Nakebenihime/deployment-workshop.git ${GITLAB_REPOSITORY}
#   - mvn $MAVEN_CLI_OPTS -s ${MAVEN_SETTINGS_XML} release:clean release:prepare release:perform -DreleaseVersion=${RELEASE_VERSION} -DdevelopmentVersion=${NEXT_SNAPSHOT_VERSION}
  when: manual
  only:
    - master

docker_build_job:
  variables:
    DOCKER_DRIVER: overlay2
  stage: deploy
  image: docker:19.03.13-dind
  services:
    - name: docker:19.03.13-dind
  only:
    changes:
      - greeting/**/*
  before_script:
    - docker login -u ${CI_USER} -p ${CI_TOKEN} ${CI_REGISTRY}
    - docker info
  script:
    - docker build -t ${CI_REGISTRY}/nakebenihime/deployment-workshop/greeting-webservice -f greeting/Dockerfile .
    - docker push ${CI_REGISTRY}/nakebenihime/deployment-workshop/greeting-webservice
  after_script:
    - docker logout ${CI_REGISTRY}

#ssh-deploy-qualification:
#  stage: deploy
#  image: kroniak/ssh-client
#  variables:
#    SPRING_PROFILES_ACTIVE: qualification
#  environment:
#    name: qualification
#    url: x
#  only:
#    refs:
#      - branches
#    changes:
#      - greeting/**/*
#  except:
#    refs:
#      - master
#  before_script:
#    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
#    - eval $(ssh-agent -s)
#    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#    - mkdir -p ~/.ssh
#    - chmod 700 ~/.ssh
#    - ssh-keyscan -t rsa ${SSH_REMOTE_HOST} >> ~/.ssh/known_hosts
#    - chmod 644 ~/.ssh/known_hosts
#  script:
#    - ssh deployer@${SSH_REMOTE_HOST} "docker login -u ${CI_USER} -p ${CI_TOKEN} ${CI_REGISTRY}"
#    - ssh deployer@${SSH_REMOTE_HOST} "docker pull ${CI_REGISTRY}/nakebenihime/deployment-workshop/greeting-service"
#    - ssh deployer@${SSH_REMOTE_HOST} 'docker stop $(docker ps -aq)' || true
#    - ssh deployer@${SSH_REMOTE_HOST} "docker run  --rm -d -p ${PORT}:8080 --name ${APP_NAME} -e SPRING_PROFILES_ACTIVE=${SPRING_ACTIVE_PROFILE} ${CI_REGISTRY}/nakebenihime/deployment-workshop/greeting-service"
#
#ssh-deploy-production:
#  stage: deploy
#  image: kroniak/ssh-client
#  variables:
#    SPRING_PROFILES_ACTIVE: production
#  environment:
#    name: production
#    url: x
#  only:
#    refs:
#      - master
#    changes:
#      - greeting/**/*
#  before_script:
#    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
#    - eval $(ssh-agent -s)
#    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#    - mkdir -p ~/.ssh
#    - chmod 700 ~/.ssh
#    - ssh-keyscan -t rsa ${SSH_REMOTE_HOST} >> ~/.ssh/known_hosts
#    - chmod 644 ~/.ssh/known_hosts
#  script:
#    - ssh deployer@${SSH_REMOTE_HOST} "docker login -u ${CI_USER} -p ${CI_TOKEN} ${CI_REGISTRY}"
#    - ssh deployer@${SSH_REMOTE_HOST} "docker pull ${CI_REGISTRY}/nakebenihime/deployment-workshop/greeting-service"
#    - ssh deployer@${SSH_REMOTE_HOST} 'docker stop $(docker ps -aq)' || true
#    - ssh deployer@${SSH_REMOTE_HOST} "docker run  --rm -d -p ${PORT}:8080 --name ${APP_NAME} -e SPRING_PROFILES_ACTIVE=${SPRING_ACTIVE_PROFILE} ${CI_REGISTRY}/nakebenihime/deployment-workshop/greeting-service"
#
